### AWS Glacier Rsync Like Utility
Rsync like utility to back up files and folders to AWS Glacier. Utility can compress files and store on Glacier. Archive ids will be stored in an sqlite database.

You have to log in to AWS with `awscli` and create a glacier vault beforehand.

#### AWS CLI install

Follow Amazon's guides for installing the `awscli` on your system, if you are using Windows or MacOS. For Linux, see instructions below.


##### Linux Install

If your Linux system package tool as the specific `awscli` tool available for installation, just use that.

If your Linux system does not offer the package, here is a simple workaround to install the python awscli tool.

To install the `awscli` on Ubuntu, you can follow these steps:

```
sudo apt update
sudo apt install python3 python3-pip
```

Navigate to the downloaded directory for `glacier-rsync` and create a virtual-python environment, then install the PIP version of the AWS CLI. Example commands:

```
cd glacier-rsync
python3 -m venv .venv
source .venv/bin/activate
pip install awscli
```

#### About Encryption

Files are encrypted locally on your own local machine. Only encrypted data is ever sent to AWS Glacier. The encryption key never leaves your system. AWS only sees the encrypted version of your files. 

To verify this yourself, you could:
- Check AWS Glacier console - the stored files will be encrypted

Without your encryption key, the files in Glacier are unreadable.

##### Encryption Algorithm Details

The program uses the Fernet encryption scheme from the cryptography library, which is built on AES-256 in CBC mode with PKCS7 padding and includes an HMAC with SHA256 for integrity verification.

##### Encryption and Upload Workflow

The process flow is:

```
Original File
    ↓
Encryption (local)
    ↓
Optional Compression (local)
    ↓
Upload to Glacier (encrypted data only)
```

##### Encryption Key Security Notes

###### Key requirements

Must be 32 bytes (256 bits) before base64 encoding
Must be url-safe base64 encoded
Should be stored securely

###### Key storage best practices:

Create secure key directory:

```
mkdir -p ~/.glacier-keys
chmod 700 ~/.glacier-keys
```

Store key with restricted permissions:

```
cat your_key > ~/.glacier-keys/backup.key
chmod 600 ~/.glacier-keys/backup.key
```


### Usage

Run params:
```shell
$ grsync --help
usage: grsync version 0.3.5 [-h] [--loglevel {CRITICAL,FATAL,ERROR,WARN,WARNING,INFO,DEBUG,NOTSET}] [--db db] --vault vault --region region [--compress COMPRESS] [--part-size PART_SIZE] [--desc desc] src

Rsync like glacier backup util

positional arguments:
  src                   file or folder to generate archive from

optional arguments:
  -h, --help            show this help message and exit
  --loglevel {CRITICAL,FATAL,ERROR,WARN,WARNING,INFO,DEBUG,NOTSET}
                        log level (default: INFO)
  --db db               database file to store sync info (default: glacier.db)
  --vault vault         Glacier vault name (default: None)
  --region region       Glacier region name (default: None)
  --compress COMPRESS   Enable compression. Only zstd is supported (default: False)
  --part-size PART_SIZE
                        Part size for compression (default: 1048576)
  --desc desc           A description for the archive that will be stored in Amazon Glacier (default: None)
  

  --compress true       Add compression (requires zstandard package)
  --part-size SIZE      Set custom part size for large files (in bytes), for example (4MB): 4194304  
  --desc "Description"  Add description
  --loglevel DEBUG      Set log level
  
```

If compression is enabled, file will be read and compressed on the fly and uploaded to glacier multipart.

Sqlite database scheme:
```sqlite
CREATE TABLE 
    sync_history
(id          integer primary key,
 path        text,		/* full path of the backed up file */
 file_size   integer,	/* size of the file */
 mtime       float,		/* modification time */
 archive_id  text, /* archive id generated by glacier */
 location    text, /* archive url generated by glacier */
 checksum    text, /* checksum of the archive generated by glacier*/
 compression text, /* compression algorithm used. NULL if none */
 timestamp   text /* backup timestamp */
);
```

### Do not lose your database

Currently, there is no way to rebuild it from aws inventory.

#### Known Issues

- Glacier supports 1024 bytes of description, and I'm currently putting a description in this format:

```
grsync|abs_file_path|size|mtime|user_desc
```

Which is not posix compatible since there is no limit to the filename or full path. I can put a metadata in front of
every archive but this means that the data can be recovered only with the same tool

- If the absolute file path changes, grsync will treat it as a different file and re-upload
- Currently, there is no way to recover the local database, but you can download the inventory with aws cli and download
  individual files with the help of description. I maybe create a tool to re-create the local db with inventory
  retrieval, but the first issue has to be addressed before.

### Workflow Usage
    
Store your `encryption key` safely - if you lose it, you can't decrypt your backups!

The `backup.db` file keeps track of what has been backed up - don't delete it!

#### First-time backup with compression and encryption (manual enter key)

```
grsync --vault YOUR-VAULT-NAME \
       --region YOUR-AWS-REGION \
       --compress true \
       --encrypt true \
       --encryption-key "your-base64-encoded-key" \
       --db /path/to/backup.db \
       --desc "My description" \
       /path/to/your/folder
```
#### First-time backup with compression and encryption (using key file)

```
grsync --vault YOUR-VAULT-NAME \
       --region YOUR-AWS-REGION \
       --compress true \
       --encrypt true \
       --encryption-key-file "/path/to/key.txt" \
       --db /path/to/backup.db \
       --desc "My description" \
       /path/to/your/folder
```
       
#### First-time backup with without encryption

```
grsync --vault YOUR-VAULT-NAME \
       --region YOUR-AWS-REGION \
       --db /path/to/backup.db \
       --desc "My description" \
       /path/to/your/folder
```


#### Subsequent syncs / Rsycing (manual enter key)

ALWAYS use the same:

- Encryption key
- Database file
- Glacier Vault name
- Region

The `--desc` argument is not necessary for syncing after the initial upload.

Use the same parameters as your initial backup.

```
grsync --vault YOUR-VAULT-NAME \
       --region YOUR-AWS-REGION \
       --encrypt true \
       --encryption-key "your-base64-encoded-key" \
       --db /path/to/backup.db \
       /path/to/your/folder
```

#### Subsequent syncs / Rsycing (using key filey)


```
grsync --vault YOUR-VAULT-NAME \
       --region YOUR-AWS-REGION \
       --encrypt true \
       --encryption-key-file /home/user/.glacier-keys/backup.key \
       --db /path/to/backup.db \
       /path/to/your/folder
```
       
This workflow will:
- Check each file against the database
- Upload new files
- Re-upload modified files
- Keep track of all uploads in the database


  
### Development Unit Testing

For testing, you need to install `pytest` and `pytest-cov` and `pytest-timeout`.

#### Run all tests
```
pytest
```

#### Run specific test file

```
pytest tests/test_backup_util.py
```

#### Run with coverage report

```
pytest --cov=glacier_rsync tests/
```
